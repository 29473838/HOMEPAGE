{% extends "base.html" %}
{% block title %}방송 정보{% endblock %}

{% block content %}
<h1 class="page-title">방송 정보</h1>

{# 현재 방송 상태 #}
<div class="card">
    <h3>현재 상태</h3>

    {% if current_stream and current_stream.status == "방송중" %}
        <p style="margin-bottom:8px;">
            <strong>상태:</strong>
            <span style="color:#e53935; font-weight:bold;">● 방송중</span>
            ({{ current_stream.platform }})
        </p>

        {% if current_stream.thumbnail_url %}
            <div style="margin-top:8px;">
                <img src="{{ current_stream.thumbnail_url }}"
                     alt="현재 방송 화면"
                     style="max-width:100%; border-radius:10px;">
            </div>
        {% endif %}

        {% if current_stream.url %}
            <p style="margin-top:10px;">
                <a href="{{ current_stream.url }}" target="_blank" class="btn">
                    {{ current_stream.platform }} 바로가기
                </a>
            </p>
        {% endif %}
    {% else %}
        <p>
            <strong>상태:</strong>
            <span style="color:#888;">
                {{ current_stream.status if current_stream else "오프라인" }}
            </span>
        </p>
    {% endif %}

    {% if current_stream and current_stream.updated_by %}
        <p style="font-size:12px;color:#777;margin-top:8px;">
            마지막 업데이트:
            <span class="nickname-label"
                  style="background: {{ current_stream.updated_by.display_color or '#444' }};">
                {{ current_stream.updated_by.username }}
            </span>
            {% if current_stream.updated_by.title %}
                <span class="title-badge">{{ current_stream.updated_by.title }}</span>
            {% endif %}
            &nbsp;/ {{ current_stream.updated_at.strftime("%Y-%m-%d %H:%M") }}
        </p>
    {% endif %}
</div>

{# ====== 방송 일정 달력 ====== #}
<div class="card" style="margin-top:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        {# 이전/다음 달 이동 #}
        {% set prev_year = year %}
        {% set prev_month = month - 1 %}
        {% if prev_month == 0 %}
            {% set prev_month = 12 %}
            {% set prev_year = year - 1 %}
        {% endif %}

        {% set next_year = year %}
        {% set next_month = month + 1 %}
        {% if next_month == 13 %}
            {% set next_month = 1 %}
            {% set next_year = year + 1 %}
        {% endif %}

        <a href="{{ url_for('stream_page', year=prev_year, month=prev_month) }}" class="btn-small">
            ◀ 이전 달
        </a>

        <h3 style="margin:0;">
            {{ year }}년 {{ "%02d"|format(month) }}월 방송 일정
        </h3>

        <a href="{{ url_for('stream_page', year=next_year, month=next_month) }}" class="btn-small">
            다음 달 ▶
        </a>
    </div>

    <table style="width:100%; border-collapse:collapse; text-align:center; table-layout:fixed;">
        <thead>
            <tr>
                <th style="padding:4px 0; border-bottom:1px solid #ddd; color:#e53935;">월</th>
                <th style="padding:4px 0; border-bottom:1px solid #ddd;">화</th>
                <th style="padding:4px 0; border-bottom:1px solid #ddd;">수</th>
                <th style="padding:4px 0; border-bottom:1px solid #ddd;">목</th>
                <th style="padding:4px 0; border-bottom:1px solid #ddd;">금</th>
                <th style="padding:4px 0; border-bottom:1px solid #ddd; color:#1e88e5;">토</th>
                <th style="padding:4px 0; border-bottom:1px solid #ddd; color:#e53935;">일</th>
            </tr>
        </thead>
        <tbody>
            {% for week in weeks %}
            <tr>
                {% for d in week %}
                    {% set is_this_month = (d.month == month) %}
                    {% set day_num = d.day if is_this_month else '' %}
                    {% set is_today = (d == today) %}

                    <td style="vertical-align:top; border-bottom:1px solid #eee; border-right:1px solid #f5f5f5; padding:4px; font-size:12px;
                               background: {% if not is_this_month %}#fafafa{% else %}#ffffff{% endif %};">

                        {% if day_num %}
                            <div style="text-align:right; font-weight:bold;
                                        {% if is_today %}color:#e53935;{% else %}color:#333;{% endif %}">
                                {{ day_num }}
                            </div>

                            {# 이 날의 방송 일정 #}
                            {% set day_schedules = schedule_by_day.get(day_num, []) %}
                            {% for s in day_schedules %}
                                <div style="margin-top:2px; text-align:left;">
                                    <span style="font-size:11px; font-weight:bold;">
                                        [{{ s.platform }}]
                                    </span>
                                    <span style="font-size:11px;">
                                        {{ s.title }}
                                    </span>
                                    <div style="font-size:10px; color:#666; margin-left:2px;">
                                        {{ s.start_at.strftime("%H:%M") }}
                                        {% if s.end_at %} ~ {{ s.end_at.strftime("%H:%M") }}{% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}

                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{# ====== 이번 달 일정 리스트 (보기 편하게) ====== #}
<div class="card" style="margin-top:20px;">
    <h3>이번 달 방송 일정 목록</h3>
    {% if schedules %}
        {% for s in schedules %}
            <div style="border-bottom:1px solid #eee; padding:6px 0; font-size:14px;">
                <strong>[{{ s.platform }}]</strong> {{ s.title }}
                <span style="font-size:12px;color:#666;">
                    / {{ s.start_at.strftime("%Y-%m-%d %H:%M") }}
                    {% if s.end_at %} ~ {{ s.end_at.strftime("%H:%M") }}{% endif %}
                </span>
                {% if s.memo %}
                    <div style="font-size:12px;color:#555;">메모: {{ s.memo }}</div>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p>이번 달에 등록된 방송 일정이 없습니다.</p>
    {% endif %}
</div>

{# ====== 관리자 전용 폼 (상태/일정 추가) ====== #}
{% if current_user.is_authenticated and current_user.role in ["대표","부대표","매니저"] %}
<div class="card" style="margin-top:20px;">
    <h3>관리자: 방송 상태 설정</h3>
    <form method="post">
        <input type="hidden" name="form_type" value="status">
        <label>상태</label>
        {% set cur_status = current_stream.status if current_stream else "오프라인" %}
        <select name="status">
            <option value="방송중"  {% if cur_status == "방송중" %}selected{% endif %}>방송중</option>
            <option value="녹화중"  {% if cur_status == "녹화중" %}selected{% endif %}>녹화중</option>
            <option value="업무중"  {% if cur_status == "업무중" %}selected{% endif %}>업무중</option>
            <option value="휴식중"  {% if cur_status == "휴식중" %}selected{% endif %}>휴식중</option>
            <option value="오프라인" {% if cur_status == "오프라인" %}selected{% endif %}>오프라인</option>
        </select>

        <label>플랫폼 (방송중일 때만 사용)</label>
        {% set cur_plat = current_stream.platform if current_stream else "" %}
        <select name="platform">
            <option value="" {% if not cur_plat %}selected{% endif %}>선택 안 함</option>
            <option value="치지직" {% if cur_plat == "치지직" %}selected{% endif %}>치지직</option>
            <option value="숲"   {% if cur_plat == "숲" %}selected{% endif %}>숲</option>
            <option value="유튜브" {% if cur_plat == "유튜브" %}selected{% endif %}>유튜브</option>
        </select>

        <label>방송 URL (방송중일 때 이동할 링크)</label>
        <input type="text" name="url" value="{{ current_stream.url if current_stream else '' }}">

        <label>썸네일 이미지 URL (선택)</label>
        <input type="text" name="thumbnail_url" value="{{ current_stream.thumbnail_url if current_stream else '' }}">

        <button type="submit" class="btn" style="margin-top:10px;">상태 저장</button>
    </form>
</div>

<div class="card" style="margin-top:20px;">
    <h3>관리자: 방송 일정 추가</h3>
    <form method="post">
        <input type="hidden" name="form_type" value="schedule_add">
        <label>제목</label>
        <input type="text" name="title" required>

        <label>플랫폼</label>
        <select name="platform" required>
            <option value="치지직">치지직</option>
            <option value="숲">숲</option>
            <option value="유튜브">유튜브</option>
        </select>

        <label>시작 일시</label>
        <input type="datetime-local" name="start_at" required>

        <label>종료 일시 (선택)</label>
        <input type="datetime-local" name="end_at">

        <label>메모 (선택)</label>
        <input type="text" name="memo">

        <button type="submit" class="btn" style="margin-top:10px;">일정 추가</button>
    </form>
</div>
{% endif %}

{% endblock %}


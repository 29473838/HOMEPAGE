{% extends "base.html" %}
{% block title %}ë°©ì†¡ ì •ë³´{% endblock %}

{% block content %}
<h1 class="page-title">ë°©ì†¡ ì •ë³´</h1>

{# í˜„ì¬ ë°©ì†¡ ìƒíƒœ #}
<div class="card">
    <h3>í˜„ì¬ ìƒíƒœ</h3>

    {% if current_stream and current_stream.status == "ë°©ì†¡ì¤‘" %}
        <p style="margin-bottom:8px;">
            <strong>ìƒíƒœ:</strong>
            <span style="color:#e53935; font-weight:bold;">â— ë°©ì†¡ì¤‘</span>
            ({{ current_stream.platform }})
        </p>

        {% if current_stream.thumbnail_url %}
            <div style="margin-top:8px;">
                <img src="{{ current_stream.thumbnail_url }}"
                     alt="í˜„ì¬ ë°©ì†¡ í™”ë©´"
                     style="max-width:100%; border-radius:10px;">
            </div>
        {% endif %}

        {% if current_stream.url %}
            <p style="margin-top:10px;">
                <a href="{{ current_stream.url }}" target="_blank" class="btn">
                    {{ current_stream.platform }} ë°”ë¡œê°€ê¸°
                </a>
            </p>
        {% endif %}

    {% else %}
        <p>
            <strong>ìƒíƒœ:</strong>
            <span style="color:#888;">
                {{ current_stream.status if current_stream else "ì˜¤í”„ë¼ì¸" }}
            </span>
        </p>
    {% endif %}

    {% if current_stream and current_stream.updated_by %}
        <p style="font-size:12px;color:#777;margin-top:8px;">
            ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:
            <span class="nickname-label"
                  style="background: {{ current_stream.updated_by.display_color or '#444' }};">
                {{ current_stream.updated_by.username }}
            </span>
            {% if current_stream.updated_by.title %}
                <span class="title-badge">{{ current_stream.updated_by.title }}</span>
            {% endif %}
            &nbsp;/ {{ current_stream.updated_at.strftime("%Y-%m-%d %H:%M") }}
        </p>
    {% endif %}
</div>

{# ë°©ì†¡ ì¼ì •(ìº˜ë¦°ë” ëŠë‚Œ) #}
<div class="card" style="margin-top:20px;">
    <h3>ë°©ì†¡ ì¼ì •</h3>

    {% if schedules %}
        {% set current_date = None %}
        {% for s in schedules %}
            {% set date_str = s.start_at.strftime("%Y-%m-%d") %}
            {% if date_str != current_date %}
                {% if not loop.first %}
                    <hr>
                {% endif %}
                <h4 style="margin-top:10px;">ğŸ“… {{ date_str }}</h4>
                {% set current_date = date_str %}
            {% endif %}

            <div style="padding:4px 0; font-size:14px;">
                <strong>[{{ s.platform }}]</strong>
                {{ s.title }}
                <span style="font-size:12px;color:#666;">
                    / {{ s.start_at.strftime("%H:%M") }}
                    {% if s.end_at %} ~ {{ s.end_at.strftime("%H:%M") }}{% endif %}
                </span>
                {% if s.memo %}
                    <div style="font-size:12px;color:#555;margin-left:4px;">
                        ë©”ëª¨: {{ s.memo }}
                    </div>
                {% endif %}

                {% if current_user.is_authenticated and current_user.role in ["ëŒ€í‘œ","ë¶€ëŒ€í‘œ","ë§¤ë‹ˆì €"] %}
                    <form method="post"
                          action="{{ url_for('stream_schedule_delete', schedule_id=s.id) }}"
                          style="display:inline;"
                          onsubmit="return confirm('ì´ ë°©ì†¡ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <button type="submit" class="btn-small danger">ì‚­ì œ</button>
                    </form>
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p>ë“±ë¡ëœ ë°©ì†¡ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
</div>

{# ê´€ë¦¬ì ì „ìš©: ìƒíƒœ/ì¼ì • ì…ë ¥ í¼ #}
{% if current_user.is_authenticated and current_user.role in ["ëŒ€í‘œ","ë¶€ëŒ€í‘œ","ë§¤ë‹ˆì €"] %}
<div class="card" style="margin-top:20px;">
    <h3>ê´€ë¦¬ì: ë°©ì†¡ ìƒíƒœ ì„¤ì •</h3>
    <form method="post">
        <input type="hidden" name="form_type" value="status">
        <label>ìƒíƒœ</label>
        <select name="status">
            {% set cur_status = current_stream.status if current_stream else "ì˜¤í”„ë¼ì¸" %}
            <option value="ë°©ì†¡ì¤‘"  {% if cur_status == "ë°©ì†¡ì¤‘" %}selected{% endif %}>ë°©ì†¡ì¤‘</option>
            <option value="ë…¹í™”ì¤‘"  {% if cur_status == "ë…¹í™”ì¤‘" %}selected{% endif %}>ë…¹í™”ì¤‘</option>
            <option value="ì—…ë¬´ì¤‘"  {% if cur_status == "ì—…ë¬´ì¤‘" %}selected{% endif %}>ì—…ë¬´ì¤‘</option>
            <option value="íœ´ì‹ì¤‘"  {% if cur_status == "íœ´ì‹ì¤‘" %}selected{% endif %}>íœ´ì‹ì¤‘</option>
            <option value="ì˜¤í”„ë¼ì¸" {% if cur_status == "ì˜¤í”„ë¼ì¸" %}selected{% endif %}>ì˜¤í”„ë¼ì¸</option>
        </select>

        <label>í”Œë«í¼ (ë°©ì†¡ì¤‘ì¼ ë•Œë§Œ ì‚¬ìš©)</label>
        <select name="platform">
            {% set cur_plat = current_stream.platform if current_stream else "" %}
            <option value="" {% if not cur_plat %}selected{% endif %}>ì„ íƒ ì•ˆ í•¨</option>
            <option value="ì¹˜ì§€ì§" {% if cur_plat == "ì¹˜ì§€ì§" %}selected{% endif %}>ì¹˜ì§€ì§</option>
            <option value="ìˆ²"   {% if cur_plat == "ìˆ²" %}selected{% endif %}>ìˆ²</option>
            <option value="ìœ íŠœë¸Œ" {% if cur_plat == "ìœ íŠœë¸Œ" %}selected{% endif %}>ìœ íŠœë¸Œ</option>
        </select>

        <label>ë°©ì†¡ URL (ë°©ì†¡ì¤‘ì¼ ë•Œ ì´ë™í•  ë§í¬)</label>
        <input type="text" name="url" value="{{ current_stream.url if current_stream else '' }}">

        <label>ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL (ì„ íƒ)</label>
        <input type="text" name="thumbnail_url" value="{{ current_stream.thumbnail_url if current_stream else '' }}">

        <button type="submit" class="btn" style="margin-top:10px;">ìƒíƒœ ì €ì¥</button>
    </form>
</div>

<div class="card" style="margin-top:20px;">
    <h3>ê´€ë¦¬ì: ë°©ì†¡ ì¼ì • ì¶”ê°€</h3>
    <form method="post">
        <input type="hidden" name="form_type" value="schedule_add">
        <label>ì œëª©</label>
        <input type="text" name="title" required>

        <label>í”Œë«í¼</label>
        <select name="platform" required>
            <option value="ì¹˜ì§€ì§">ì¹˜ì§€ì§</option>
            <option value="ìˆ²">ìˆ²</option>
            <option value="ìœ íŠœë¸Œ">ìœ íŠœë¸Œ</option>
        </select>

        <label>ì‹œì‘ ì¼ì‹œ</label>
        <input type="datetime-local" name="start_at" required>

        <label>ì¢…ë£Œ ì¼ì‹œ (ì„ íƒ)</label>
        <input type="datetime-local" name="end_at">

        <label>ë©”ëª¨ (ì„ íƒ)</label>
        <input type="text" name="memo">

        <button type="submit" class="btn" style="margin-top:10px;">ì¼ì • ì¶”ê°€</button>
    </form>
</div>
{% endif %}

{% endblock %}

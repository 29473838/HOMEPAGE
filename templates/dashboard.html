{% extends "base.html" %}
{% block title %}ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block content %}
<h1 class="page-title">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>

<!-- ìœ ì € ê²€ìƒ‰ -->
<div class="card">
    <h3>ìœ ì € ê²€ìƒ‰</h3>
    <form method="get" style="display:flex; gap:8px; align-items:center;">
        <input type="text" name="q" value="{{ q }}" placeholder="ë‹‰ë„¤ì„ / ì´ë©”ì¼ / ì•„ì´ë”” ê²€ìƒ‰" style="flex:1;">
        <!-- í‹°ì¼“ í˜ì´ì§€ëŠ” ìœ ì§€ -->
        <input type="hidden" name="ticket_page" value="{{ tickets.page }}">
        <button type="submit" class="btn">ê²€ìƒ‰</button>
    </form>
</div>

<!-- ìœ ì € ë¦¬ìŠ¤íŠ¸ -->
<div class="card">
    <h3>ìœ ì € ë¦¬ìŠ¤íŠ¸</h3>
    {% if users.items %}
    <table class="admin-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>ë‹‰ë„¤ì„</th>
            <th>ì§ê¸‰</th>
            <th>ì´ë©”ì¼</th>
            <th>ê²½ê³ </th>
            <th>ìƒíƒœ</th>
            <th>ì €í™”</th>
            <th>ì €í™” ê´€ë¦¬</th>
            <th>ê´€ë¦¬</th>
        </tr>
        </thead>
        <tbody>
        {% for u in users.items %}
        <tr>
            <td>{{ u.id }}</td>

            <!-- ë‹‰ë„¤ì„ + ì¹­í˜¸ -->
            <td>
                <span class="nickname-label"
                      style="background: {{ u.display_color or '#444' }};">
                    {{ u.username }}
                </span>
                {% if u.title %}
                    <span class="title-badge title-style-{{ u.title_style or 'basic' }}"
                          style="--title-main-color: {{ u.title_color or '#ff6fb5' }};">
                        {{ u.title }}
                    </span>
                {% endif %}
            </td>

            <td>{{ u.role }}</td>
            <td>{{ u.email }}</td>
            <td>{{ u.warnings or 0 }}</td>

            <td>
                {% if u.is_banned %}
                    <span style="color:#e53935; font-weight:600;">ì •ì§€</span>
                {% else %}
                    <span style="color:#4caf50; font-weight:600;">ì •ìƒ</span>
                {% endif %}
            </td>

            <!-- ğŸ”¹ ì €í™” í‘œì‹œ -->
            <td>
                <strong>{{ u.coins or 0 }}</strong> ì¥
            </td>

            <!-- ğŸ”¹ ì €í™” ê´€ë¦¬ (ì¶”ê°€ / ì œê±° / ëª°ìˆ˜) -->
            <td>
                {% if has_permission(current_user, 'warning_manage') or has_permission(current_user, 'promote') %}
                <form method="post"
                      action="{{ url_for('dashboard_update_coins', user_id=u.id) }}"
                      style="display:flex; flex-direction:column; gap:4px; min-width:210px;">

                    <div style="display:flex; gap:4px; align-items:center;">
                        <input type="number"
                               name="amount"
                               value="10"
                               min="0"
                               style="width:70px; padding:4px 6px; font-size:12px;">

                        <select name="action" style="font-size:12px; padding:4px 6px; flex:1;">
                            <option value="add">ì¶”ê°€</option>
                            <option value="sub">ì œê±°</option>
                            <option value="confiscate">ëª°ìˆ˜(0ì¥)</option>
                        </select>
                    </div>

                    <button type="submit"
                            class="btn-small"
                            style="padding:4px 8px; font-size:12px; background:#7e57c2; color:#fff; border:none; border-radius:999px;">
                        ì €í™” ì ìš©
                    </button>
                </form>
                {% else %}
                    -
                {% endif %}
            </td>

            <!-- ê¸°ì¡´ ê´€ë¦¬ ë²„íŠ¼ë“¤ -->
            <td>
                <!-- ê²½ê³  ì¦ê°€ -->
                <form method="post"
                      action="{{ url_for('admin_user_warn', user_id=u.id) }}"
                      style="display:inline-block; margin:1px 0;">
                    <button class="btn-small btn-warn"
                            style="background:#ffb300; color:#fff; border:none; border-radius:999px; padding:4px 8px; font-size:11px;">
                        ê²½ê³  +1
                    </button>
                </form>
                
                <!-- ê²½ê³  ê°ì†Œ -->
                <form method="post"
                      action="{{ url_for('admin_user_unwarn', user_id=u.id) }}"
                      style="display:inline-block; margin:1px 0;">
                    <button class="btn-small btn-safe"
                            style="background:#43a047; color:#fff; border:none; border-radius:999px; padding:4px 8px; font-size:11px;">
                        ê²½ê³  -1
                    </button>
                </form>

                <!-- ì •ì§€ / í•´ì œ -->
                {% if not u.is_banned %}
                <form method="post"
                      action="{{ url_for('admin_user_ban', user_id=u.id) }}"
                      style="display:inline-block; margin:1px 0;">
                    <button type="submit"
                            class="btn-small danger"
                            style="background:#e53935; color:#fff; border:none; border-radius:999px; padding:4px 8px; font-size:11px;">
                        ì •ì§€
                    </button>
                </form>
                {% else %}
                <form method="post"
                      action="{{ url_for('admin_user_unban', user_id=u.id) }}"
                      style="display:inline-block; margin:1px 0;">
                    <button type="submit"
                            class="btn-small"
                            style="background:#546e7a; color:#fff; border:none; border-radius:999px; padding:4px 8px; font-size:11px;">
                        ì •ì§€ í•´ì œ
                    </button>
                </form>
                {% endif %}

                <!-- ê°•ì œ ë¡œê·¸ì•„ì›ƒ -->
                <form method="post"
                      action="{{ url_for('admin_user_force_logout', user_id=u.id) }}"
                      style="display:inline-block; margin:1px 0;">
                    <button type="submit"
                            class="btn-small"
                            style="background:#5c6bc0; color:#fff; border:none; border-radius:999px; padding:4px 8px; font-size:11px;">
                        ê°•ì œ ë¡œê·¸ì•„ì›ƒ
                    </button>
                </form>

                <!-- ê³„ì • ì‚­ì œ -->
                <form method="post"
                      action="{{ url_for('admin_user_delete', user_id=u.id) }}"
                      style="display:inline-block; margin:1px 0;"
                      onsubmit="return confirm('ì •ë§ ì´ ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <button type="submit"
                            class="btn-small danger"
                            style="background:#c62828; color:#fff; border:none; border-radius:999px; padding:4px 8px; font-size:11px;">
                        ì‚­ì œ
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>ê°€ì…í•œ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}

    <!-- ìœ ì € í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="pagination">
        {% if users.has_prev %}
            <a href="{{ url_for('dashboard', user_page=users.prev_num, ticket_page=tickets.page, q=q) }}">ì´ì „</a>
        {% endif %}
        
        {% for page_num in users.iter_pages() %}
            {% if page_num %}
                {% if page_num == users.page %}
                    <strong>[{{ page_num }}]</strong>
                {% else %}
                    <a href="{{ url_for('dashboard', user_page=page_num, ticket_page=tickets.page, q=q) }}">{{ page_num }}</a>
                {% endif %}
            {% else %}
                ...
            {% endif %}
        {% endfor %}
        
        {% if users.has_next %}
            <a href="{{ url_for('dashboard', user_page=users.next_num, ticket_page=tickets.page, q=q) }}">ë‹¤ìŒ</a>
        {% endif %}
    </div>
</div>

<!-- êµ¿ì¦ˆ ê´€ë¦¬ -->
<div class="card">
    <h3>êµ¿ì¦ˆ ê´€ë¦¬</h3>

    <!-- êµ¿ì¦ˆ ì¶”ê°€ í¼ -->
    <form method="post"
          action="{{ url_for('dashboard_goods_create') }}"
          style="margin-bottom:14px;">
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
            <input type="text" name="name" placeholder="êµ¿ì¦ˆ ì´ë¦„" style="flex:1 1 140px;" required>
            <input type="number" name="price" placeholder="ê°€ê²© (ìˆ«ì, ì›)" style="width:140px;" required>
            <input type="text" name="payment_url" placeholder="ê²°ì œ/êµ¬ë§¤ í˜ì´ì§€ URL" style="flex:2 1 220px;">
            <input type="text" name="image_url" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒ)" style="flex:1 1 200px;">
        </div>
        <textarea name="description" placeholder="êµ¿ì¦ˆ ìƒì„¸ ì„¤ëª…" style="margin-top:6px;"></textarea>
        <button type="submit" class="btn-small"
                style="margin-top:6px; padding:5px 10px; border-radius:999px; border:none; background:#42a5f5; color:#fff; font-size:12px;">
            êµ¿ì¦ˆ ì¶”ê°€
        </button>
    </form>

    <!-- êµ¿ì¦ˆ ëª©ë¡ -->
    {% if goods_list %}
        <table class="admin-table">
            <tr>
                <th>ID</th>
                <th>ì´ë¦„</th>
                <th>ê°€ê²©</th>
                <th>ê´€ë¦¬</th>
            </tr>
            {% for g in goods_list %}
            <tr>
                <td>{{ g.id }}</td>
                <td>{{ g.name }}</td>
                <td>{{ "{:,}".format(g.price) }}ì›</td>
                <td>
                    <form method="post"
                          action="{{ url_for('dashboard_goods_delete', goods_id=g.id) }}"
                          style="display:inline;"
                          onsubmit="return confirm('ì´ êµ¿ì¦ˆë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <button type="submit" class="btn-small danger"
                                style="background:#c62828; color:#fff; border:none; border-radius:999px; padding:4px 8px; font-size:11px;">
                            ì‚­ì œ
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </table>
    {% else %}
        <p>ë“±ë¡ëœ êµ¿ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
</div>

<!-- í…”ëŸ°íŠ¸ / íŒ€ì› ê´€ë¦¬ -->
<div class="card">
    <h3>í…”ëŸ°íŠ¸ / íŒ€ì› ê´€ë¦¬</h3>

    <!-- í…”ëŸ°íŠ¸ ì¶”ê°€ í¼ -->
    <form method="post"
          action="{{ url_for('dashboard_talent_create') }}"
          style="margin-bottom:14px;">
        <div style="display:flex; flex-wrap:wrap; gap:8px;">
            <input type="text" name="nickname" placeholder="ë‹‰ë„¤ì„" style="flex:1 1 120px;" required>
            <input type="text" name="team" placeholder="ì†Œì† íŒ€ / ë¶€ì„œ" style="flex:1 1 140px;">
            <input type="text" name="role" placeholder="ì§ì±… / ê³„ê¸‰ (ì„ íƒ)" style="flex:1 1 120px;">
            <input type="number" name="sort_order" placeholder="ì •ë ¬ ìˆœì„œ (ì‘ì„ìˆ˜ë¡ ìœ„)" style="width:140px;">
            <input type="text" name="image_url" placeholder="í”„ë¡œí•„ ì´ë¯¸ì§€ URL (ì„ íƒ)" style="flex:1 1 200px;">
        </div>
        <textarea name="intro" placeholder="ê°„ë‹¨ ì†Œê°œê¸€" style="margin-top:6px;"></textarea>
        <button type="submit" class="btn-small"
                style="margin-top:6px; padding:5px 10px; border-radius:999px; border:none; background:#8e24aa; color:#fff; font-size:12px;">
            í…”ëŸ°íŠ¸ ì¶”ê°€
        </button>
    </form>

    <!-- í…”ëŸ°íŠ¸ ëª©ë¡ -->
    {% if talents %}
        <table class="admin-table">
            <tr>
                <th>ID</th>
                <th>ë‹‰ë„¤ì„</th>
                <th>ì†Œì†</th>
                <th>ì§ì±…</th>
                <th>ì •ë ¬</th>
                <th>ê´€ë¦¬</th>
            </tr>
            {% for t in talents %}
            <tr>
                <td>{{ t.id }}</td>
                <td>{{ t.nickname }}</td>
                <td>{{ t.team or "-" }}</td>
                <td>{{ t.role or "-" }}</td>
                <td>{{ t.sort_order }}</td>
                <td>
                    <form method="post"
                          action="{{ url_for('dashboard_talent_delete', talent_id=t.id) }}"
                          style="display:inline;"
                          onsubmit="return confirm('ì´ í…”ëŸ°íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <button type="submit" class="btn-small danger"
                                style="background:#c62828; color:#fff; border:none; border-radius:999px; padding:4px 8px; font-size:11px;">
                            ì‚­ì œ
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </table>
    {% else %}
        <p>ë“±ë¡ëœ í…”ëŸ°íŠ¸/íŒ€ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
</div>

<!-- ìµœê·¼ ë¬¸ì˜ ê¸°ë¡ -->
<div class="card">
    <h3>ë¬¸ì˜ ê¸°ë¡</h3>
    {% if tickets.items %}
        <div class="admin-table">
            {% for t in tickets.items %}
            <div class="ticket-row" style="border-bottom:1px solid #eee; padding:8px 0;">
                <div>
                    <strong>[{{ t.category }}]</strong> {{ t.subject }}
                    <span style="font-size:12px;color:#777;"> / {{ t.email_reply_to }}</span>
                    <span style="float:right;color:#888;">
                        {{ t.created_at.strftime("%Y-%m-%d %H:%M") }}
                    </span>
                </div>
                <div style="margin-top:5px;">
                    <div style="font-size:13px;white-space:pre-wrap;">
                        <strong>ë‚´ìš©:</strong> {{ t.content }}
                    </div>
                    {% if t.answer %}
                    <div style="font-size:13px;white-space:pre-wrap;margin-top:4px;">
                        <strong>ë‹µë³€:</strong> {{ t.answer }}
                    </div>
                    {% endif %}
                    <div style="margin-top:4px;font-size:12px;">
                        ìƒíƒœ:
                        {% if t.status == "ëŒ€ê¸°ì¤‘" %}
                            <span style="color:#ff9800;">ëŒ€ê¸°ì¤‘</span>
                        {% elif t.status == "ì²˜ë¦¬ì¤‘" %}
                            <span style="color:#2196f3;">ì²˜ë¦¬ì¤‘</span>
                        {% elif t.status == "ì²˜ë¦¬ì™„ë£Œ" %}
                            <span style="color:#4caf50;">ì²˜ë¦¬ì™„ë£Œ</span>
                        {% elif t.status == "ì²˜ë¦¬ë¶ˆê°€" %}
                            <span style="color:#f44336;">ì²˜ë¦¬ë¶ˆê°€</span>
                        {% else %}
                            <span>{{ t.status }}</span>
                        {% endif %}
                    </div>
                </div>

                <!-- ìƒíƒœ/ë‹µë³€ ìˆ˜ì • + ì‚­ì œ ë²„íŠ¼ -->
                <div style="margin-top:6px;">
                    <form method="post"
                          action="{{ url_for('admin_ticket_status', ticket_id=t.id) }}"
                          style="display:inline-block; margin-right:8px;">
                        <select name="status">
                            <option value="ëŒ€ê¸°ì¤‘"   {% if t.status == "ëŒ€ê¸°ì¤‘" %}selected{% endif %}>ëŒ€ê¸°ì¤‘</option>
                            <option value="ì²˜ë¦¬ì¤‘"   {% if t.status == "ì²˜ë¦¬ì¤‘" %}selected{% endif %}>ì²˜ë¦¬ì¤‘</option>
                            <option value="ì²˜ë¦¬ì™„ë£Œ" {% if t.status == "ì²˜ë¦¬ì™„ë£Œ" %}selected{% endif %}>ì²˜ë¦¬ì™„ë£Œ</option>
                            <option value="ì²˜ë¦¬ë¶ˆê°€" {% if t.status == "ì²˜ë¦¬ë¶ˆê°€" %}selected{% endif %}>ì²˜ë¦¬ë¶ˆê°€</option>
                        </select>
                        <input type="text" name="answer" placeholder="ë‹µë³€ ë‚´ìš©(ì„ íƒ)" style="width:260px;">
                        <button type="submit"
                                class="btn-small"
                                style="background:#26a69a; color:#fff; border:none; border-radius:999px; padding:4px 8px; font-size:11px;">
                            ì €ì¥
                        </button>
                    </form>

                    <form method="post"
                          action="{{ url_for('admin_ticket_delete', ticket_id=t.id) }}"
                          style="display:inline-block;"
                          onsubmit="return confirm('ì´ ë¬¸ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                        <button type="submit"
                                class="btn-small danger"
                                style="background:#c62828; color:#fff; border:none; border-radius:999px; padding:4px 8px; font-size:11px;">
                            ì‚­ì œ
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p>ë¬¸ì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}

    <!-- ë¬¸ì˜ í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="pagination">
        {% if tickets.has_prev %}
            <a href="{{ url_for('dashboard', user_page=users.page, ticket_page=tickets.prev_num, q=q) }}">ì´ì „</a>
        {% endif %}

        {% for page_num in tickets.iter_pages() %}
            {% if page_num %}
                {% if page_num == tickets.page %}
                    <strong>[{{ page_num }}]</strong>
                {% else %}
                    <a href="{{ url_for('dashboard', user_page=users.page, ticket_page=page_num, q=q) }}">{{ page_num }}</a>
                {% endif %}
            {% else %}
                ...
            {% endif %}
        {% endfor %}

        {% if tickets.has_next %}
            <a href="{{ url_for('dashboard', user_page=users.page, ticket_page=tickets.next_num, q=q) }}">ë‹¤ìŒ</a>
        {% endif %}
    </div>
</div>

{% endblock %}
